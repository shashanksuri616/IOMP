<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HyPE RAG Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-4xl mx-auto p-4">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">HyPE RAG Chat</h1>
      <p class="text-sm text-gray-600">Ask questions with inline citations â€” upload files or build from the web.</p>
    </header>

    <nav class="mb-4">
      <div class="inline-flex rounded border overflow-hidden">
        <button id="tabUpload" class="px-4 py-2 bg-blue-600 text-white">Upload & Ask</button>
        <button id="tabWeb" class="px-4 py-2 bg-white text-blue-600">Ask from Web</button>
      </div>
    </nav>

    <!-- Upload & Ask Panel -->
    <div id="panelUpload" class="space-y-4">
      <section class="p-4 bg-white rounded shadow">
        <div class="grid md:grid-cols-3 gap-3 items-end">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Upload files (PDF, TXT, MD, DOCX, CSV, JSON, HTML, XLSX)</label>
            <input id="fileInput" type="file" multiple class="w-full" />
          </div>
          <div class="flex gap-2">
            <button id="btnUpload" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">Build Index</button>
          </div>
        </div>
        <p id="status" class="text-sm text-gray-600 mt-2"></p>
      </section>

      <section class="p-4 bg-white rounded shadow">
        <div class="flex items-center gap-3 mb-3">
          <label class="text-sm font-medium">k</label>
          <input id="kVal" type="number" value="5" min="1" max="20" class="w-20 border rounded px-2 py-1" />
        </div>
        <textarea id="question" rows="3" class="w-full border rounded px-3 py-2" placeholder="Type your question..."></textarea>
        <div class="flex justify-end mt-3">
          <button id="btnAsk" class="bg-emerald-600 hover:bg-emerald-700 text-white rounded px-4 py-2">Ask</button>
        </div>
      </section>
    </div>

    <!-- Web Build Panel -->
    <div id="panelWeb" class="space-y-4 hidden">
      <section class="p-4 bg-white rounded shadow">
        <div class="grid md:grid-cols-2 gap-3">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Web query</label>
            <input id="webQuery" type="text" class="w-full border rounded px-3 py-2" placeholder="e.g., Document summary 200 words" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Or paste URLs (one per line)</label>
            <textarea id="webUrls" rows="3" class="w-full border rounded px-3 py-2" placeholder="https://example.com/page-1\nhttps://example.com/page-2"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Top K pages</label>
            <input id="webTopK" type="number" value="5" min="1" max="10" class="w-28 border rounded px-2 py-1" />
          </div>
          <div class="flex items-center gap-2">
            <input id="webStrictEn" type="checkbox" checked class="h-4 w-4" />
            <label class="text-sm">English only</label>
          </div>
          <div class="flex items-center gap-2">
            <input id="webEnglishWorldwide" type="checkbox" checked class="h-4 w-4" />
            <label class="text-sm">English (worldwide)</label>
          </div>
          <div class="flex items-center gap-2">
            <input id="webRedditOnly" type="checkbox" checked class="h-4 w-4" />
            <label class="text-sm">Reddit only</label>
          </div>
        </div>
        <details class="mt-3">
          <summary class="cursor-pointer text-sm font-semibold">Advanced options</summary>
          <div class="grid md:grid-cols-3 gap-3 mt-3">
            
            <div>
              <label class="block text-sm font-medium mb-1">Timeframe</label>
              <select id="webTimelimit" class="w-full border rounded px-2 py-1">
                <option value="">Any time</option>
                <option value="d">Past day</option>
                <option value="w">Past week</option>
                <option value="m">Past month</option>
                <option value="y">Past year</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Per-domain limit</label>
              <input id="webPerDomain" type="number" value="1" min="0" max="5" class="w-full border rounded px-2 py-1" />
            </div>
            <div class="md:col-span-3">
              <label class="block text-sm font-medium mb-1">Block domains (comma separated)</label>
              <input id="webBlock" type="text" class="w-full border rounded px-2 py-1" placeholder="wikipedia.org, reddit.com" />
            </div>
            <div class="flex items-center gap-2">
              <input id="webIncludePDF" type="checkbox" class="h-4 w-4" />
              <label class="text-sm">Include PDFs</label>
            </div>
            <div class="flex items-center gap-2">
              <input id="webUseWiki" type="checkbox" class="h-4 w-4" checked />
              <label class="text-sm">Allow Wikipedia fallback</label>
            </div>
            <div class="flex items-center gap-2">
              <input id="webIncludeForums" type="checkbox" class="h-4 w-4" checked />
              <label class="text-sm">Include forums (Reddit, StackOverflow/Exchange)</label>
            </div>
            <div class="flex items-center gap-2">
              <input id="webIncludeGithubForums" type="checkbox" class="h-4 w-4" />
              <label class="text-sm">Include GitHub Discussions (off by default)</label>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Min distinct sources (domains/subreddits)</label>
              <input id="webMinDistinct" type="number" value="3" min="1" max="10" class="w-full border rounded px-2 py-1" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Min keyword hits</label>
              <input id="webMinHits" type="number" value="2" min="0" max="10" class="w-full border rounded px-2 py-1" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Min keyword ratio</label>
              <input id="webMinRatio" type="number" value="0.25" step="0.05" min="0" max="1" class="w-full border rounded px-2 py-1" />
            </div>
            <div class="flex items-center gap-2">
              <input id="webDebug" type="checkbox" class="h-4 w-4" />
              <label class="text-sm">Return debug</label>
            </div>
          </div>
        </details>
        <div class="flex justify-end mt-3">
          <button id="btnWebBuild" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded px-4 py-2">Build from Web</button>
        </div>
        <p id="webStatus" class="text-sm text-gray-600 mt-2"></p>
        <div id="webDebugWrap" class="mt-2 hidden">
          <pre id="webDebugOut" class="text-xs whitespace-pre-wrap bg-gray-100 p-2 rounded"></pre>
        </div>
      </section>

      <section class="p-4 bg-white rounded shadow">
        <div class="flex items-center gap-3 mb-3">
          <label class="text-sm font-medium">k</label>
          <input id="kValWeb" type="number" value="5" min="1" max="20" class="w-20 border rounded px-2 py-1" />
        </div>
        <textarea id="questionWeb" rows="3" class="w-full border rounded px-3 py-2" placeholder="Type your question..."></textarea>
        <div class="flex justify-end mt-3">
          <button id="btnAskWeb" class="bg-emerald-600 hover:bg-emerald-700 text-white rounded px-4 py-2">Ask</button>
        </div>
      </section>
    </div>

    <section id="results" class="space-y-4 mt-4"></section>
  </div>

  <script>
    // Tabs
    const tabUpload = document.getElementById('tabUpload');
    const tabWeb = document.getElementById('tabWeb');
    const panelUpload = document.getElementById('panelUpload');
    const panelWeb = document.getElementById('panelWeb');

    function switchTab(which) {
      if (which === 'upload') {
        tabUpload.className = 'px-4 py-2 bg-blue-600 text-white';
        tabWeb.className = 'px-4 py-2 bg-white text-blue-600';
        panelUpload.classList.remove('hidden');
        panelWeb.classList.add('hidden');
      } else {
        tabUpload.className = 'px-4 py-2 bg-white text-blue-600';
        tabWeb.className = 'px-4 py-2 bg-blue-600 text-white';
        panelUpload.classList.add('hidden');
        panelWeb.classList.remove('hidden');
      }
    }

    tabUpload.addEventListener('click', () => switchTab('upload'));
    tabWeb.addEventListener('click', () => switchTab('web'));

    // Upload panel elements
    const fileInput = document.getElementById('fileInput');
    const kInput = document.getElementById('kVal');
    const qInput = document.getElementById('question');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');

    // Web panel elements
    const webQuery = document.getElementById('webQuery');
  const webTopK = document.getElementById('webTopK');
    const webStrictEn = document.getElementById('webStrictEn');
  const webEnglishWorldwide = document.getElementById('webEnglishWorldwide');
  const webRedditOnly = document.getElementById('webRedditOnly');
  const webStatus = document.getElementById('webStatus');
    const kInputWeb = document.getElementById('kValWeb');
    const qInputWeb = document.getElementById('questionWeb');
  const webUrls = document.getElementById('webUrls');
  // Advanced
  const webTimelimit = document.getElementById('webTimelimit');
  const webPerDomain = document.getElementById('webPerDomain');
  const webBlock = document.getElementById('webBlock');
  const webIncludePDF = document.getElementById('webIncludePDF');
  const webUseWiki = document.getElementById('webUseWiki');
  const webIncludeForums = document.getElementById('webIncludeForums');
  const webIncludeGithubForums = document.getElementById('webIncludeGithubForums');
  const webMinDistinct = document.getElementById('webMinDistinct');
  const webMinHits = document.getElementById('webMinHits');
  const webMinRatio = document.getElementById('webMinRatio');
  const webDebug = document.getElementById('webDebug');
  const webDebugWrap = document.getElementById('webDebugWrap');
  const webDebugOut = document.getElementById('webDebugOut');

    function apiUrl(path) {
      // Hardcode to local FastAPI for now
      return 'http://localhost:8000' + (path.startsWith('/') ? path : '/' + path);
    }

  async function uploadAndBuild() {
      const files = fileInput.files;
      if (!files || !files.length) {
        alert('Select one or more files');
        return;
      }
      statusEl.textContent = 'Uploading and building index...';
      try {
        const fd = new FormData();
        for (const f of files) fd.append('files', f);
        const resp = await fetch(apiUrl('/upload'), { method: 'POST', body: fd });
        const data = await resp.json();
        if (resp.ok) {
          statusEl.textContent = `Index built: ${data.documents} docs, ${data.chunks} chunks (saved as ${data.index_name})`;
        } else {
          const detail = data.detail || data.error;
          statusEl.textContent = 'Error: ' + (detail || resp.statusText);
        }
      } catch (e) {
        statusEl.textContent = 'Error: ' + e.message;
      }
    }

    function renderAnswer(answer, sources) {
      const wrap = document.createElement('div');
      wrap.className = 'p-4 bg-white rounded shadow';

      const a = document.createElement('div');
      a.className = 'whitespace-pre-wrap';
      a.textContent = answer;
      wrap.appendChild(a);

      if (Array.isArray(sources) && sources.length) {
        const ul = document.createElement('ul');
        ul.className = 'mt-3 text-sm text-gray-700 list-disc pl-6';
        for (const s of sources) {
          const li = document.createElement('li');
          li.textContent = `${s.label} - ${s.source}`;
          ul.appendChild(li);
        }
        wrap.appendChild(ul);
      }

      resultsEl.prepend(wrap);
    }

    async function ask() {
      const question = qInput.value.trim();
      const k = parseInt(kInput.value, 10) || 5;
      if (!question) return;
      statusEl.textContent = 'Asking...';
      try {
        const resp = await fetch(apiUrl('/ask'), {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ question, k })
        });
        const data = await resp.json();
        if (resp.ok) {
          renderAnswer(data.answer, data.sources);
          statusEl.textContent = '';
        } else {
          statusEl.textContent = 'Error: ' + (data.error || resp.statusText);
        }
      } catch (e) {
        statusEl.textContent = 'Error: ' + e.message;
      }
    }

    async function webBuild() {
      const query = webQuery.value.trim();
      const urlsRaw = webUrls.value.trim();
      const top_k = parseInt(webTopK.value, 10) || 5;
      const strict_en_only = !!webStrictEn.checked;
      const english_worldwide = !!webEnglishWorldwide.checked;
      const reddit_only = !!webRedditOnly.checked;
      webStatus.textContent = 'Building web index...';
      webDebugWrap.classList.add('hidden');
      webDebugOut.textContent = '';
      try {
        if (urlsRaw) {
          // Build from pasted URLs
          const urls = urlsRaw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
          const resp = await fetch(apiUrl('/web_build_urls'), {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ urls, strict_en_only })
          });
          const data = await resp.json();
          if (resp.ok) {
            webStatus.textContent = `Web index built: ${data.documents} docs, ${data.chunks} chunks (saved as ${data.index_name})`;
          } else {
            webStatus.textContent = 'Error: ' + (data.detail || resp.statusText);
          }
          return;
        }
        if (!query) {
          alert('Enter a web query or paste URLs');
          webStatus.textContent = '';
          return;
        }
        // Build from search query
        const block_domains = webBlock.value.split(',').map(s => s.trim()).filter(Boolean);
        const resp = await fetch(apiUrl('/web_build'), {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({
            query,
            top_k,
            strict_en_only,
            english_worldwide,
            timelimit: webTimelimit.value || null,
            per_domain_limit: parseInt(webPerDomain.value, 10) || 1,
            block_domains,
            include_pdfs: !!webIncludePDF.checked,
            use_wikipedia_fallback: reddit_only ? false : !!webUseWiki.checked,
            include_forums: !!webIncludeForums.checked,
            include_github_forums: !!webIncludeGithubForums.checked,
            min_distinct_sources: parseInt(webMinDistinct.value, 10) || 3,
            min_keyword_hits: parseInt(webMinHits.value, 10) || 2,
            min_keyword_ratio: parseFloat(webMinRatio.value) || 0.25,
            reddit_only,
            debug: !!webDebug.checked,
          })
        });
        const data = await resp.json();
        if (resp.ok) {
          webStatus.textContent = `Web index built: ${data.documents} docs, ${data.chunks} chunks (saved as ${data.index_name})`;
          if (webDebug.checked && data.debug) {
            const accepted = data.debug.filter(x => x.accepted);
            const sites = new Map();
            const subs = new Map();
            for (const it of accepted) {
              const dom = it.domain || '';
              const sk = it.source_key || '';
              if (dom) sites.set(dom, (sites.get(dom) || 0) + 1);
              if (sk && sk.startsWith('reddit:')) subs.set(sk, (subs.get(sk) || 0) + 1);
            }
            const siteStr = [...sites.entries()].map(([k,v]) => `${k} x${v}`).join(', ');
            const subStr = [...subs.entries()].map(([k,v]) => `${k} x${v}`).join(', ');
            webDebugOut.textContent = `Accepted: ${accepted.length}\nSites: ${siteStr}\nSubreddits: ${subStr}\n\nFull debug:\n` + JSON.stringify(data.debug, null, 2);
            webDebugWrap.classList.remove('hidden');
          }
        } else {
          if (webDebug.checked && data.detail && data.detail.debug) {
            webDebugOut.textContent = `[Error] ${data.detail.error || data.detail} \n\n` + JSON.stringify(data.detail.debug, null, 2);
            webDebugWrap.classList.remove('hidden');
          }
          webStatus.textContent = 'Error: ' + ((data.detail && data.detail.error) || data.detail || resp.statusText);
        }
      } catch (e) {
        webStatus.textContent = 'Error: ' + e.message;
      }
    }

    async function askWeb() {
      const question = qInputWeb.value.trim();
      const k = parseInt(kInputWeb.value, 10) || 5;
      if (!question) return;
      webStatus.textContent = 'Asking...';
      try {
        const resp = await fetch(apiUrl('/ask'), {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ question, k })
        });
        const data = await resp.json();
        if (resp.ok) {
          renderAnswer(data.answer, data.sources);
          webStatus.textContent = '';
        } else {
          webStatus.textContent = 'Error: ' + (data.error || resp.statusText);
        }
      } catch (e) {
        webStatus.textContent = 'Error: ' + e.message;
      }
    }

    // History and index suggestion are removed when working with uploads

    document.getElementById('btnUpload').addEventListener('click', uploadAndBuild);
    document.getElementById('btnAsk').addEventListener('click', ask);
    document.getElementById('btnWebBuild').addEventListener('click', webBuild);
    document.getElementById('btnAskWeb').addEventListener('click', askWeb);
  </script>
</body>
</html>
